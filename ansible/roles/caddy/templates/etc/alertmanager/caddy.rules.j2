# Alert rules for Caddy
# Managed by Ansible - DO NOT EDIT MANUALLY

groups:
- name: caddy
  rules:
  - alert: CaddyDown
    expr: up{job="caddy"} == 0
    for: 5m
    labels:
      severity: critical
      service: caddy
    annotations:
      summary: "Caddy instance {{ $labels.instance }} is down"
      description: "Caddy has been down for more than 5 minutes on {{ $labels.instance }}"

  - alert: HighRequestLatency
    expr: histogram_quantile(0.99, sum(rate(caddy_http_request_duration_seconds_bucket[5m])) by (le)) > 1
    for: 10m
    labels:
      severity: warning
      service: caddy
    annotations:
      summary: "High request latency on {{ $labels.instance }}"
      description: "99th percentile request latency is {{ $value }}s on {{ $labels.instance }}"

  - alert: HighErrorRate
    expr: rate(caddy_http_response_status_code_count{status_code=~"5.."}[5m]) / rate(caddy_http_response_status_code_count[5m]) * 100 > 5
    for: 15m
    labels:
      severity: warning
      service: caddy
    annotations:
      summary: "High error rate on {{ $labels.instance }}"
      description: "Error rate is {{ $value }}% on {{ $labels.instance }}"

  - alert: HighMemoryUsage
    expr: (process_resident_memory_bytes / process_virtual_memory_bytes) * 100 > 80
    for: 10m
    labels:
      severity: warning
      service: caddy
    annotations:
      summary: "High memory usage on {{ $labels.instance }}"
      description: "Memory usage is {{ $value }}% on {{ $labels.instance }}"
