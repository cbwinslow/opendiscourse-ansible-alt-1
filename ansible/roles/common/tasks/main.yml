---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Upgrade all packages
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes

- name: Install base packages
  apt:
    name:
      - build-essential
      - python3-pip
      - python3-venv
      - curl
      - wget
      - git
      - sudo
      - ufw
      - fail2ban
      - vim
      - htop
      - net-tools
      - tree
      - jq
    state: present

- name: Configure timezone
  community.general.timezone:
    name: "{{ timezone }}"

- name: Configure SSH
  template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    mode: '0600'
  notify: restart ssh

- name: (Legacy) Deploy raw UFW user.rules template (optional)
  template:
    src: ufw_rules.j2
    dest: /etc/ufw/user.rules
  notify: restart ufw
  when: (manage_raw_ufw_user_rules | default(false)) | bool and (firewall_enabled | default(enable_basic_firewall | default(true))) | bool
  tags: [ 'firewall' ]

- name: Ensure UFW default incoming policy
  ufw:
    state: reset
  when: (firewall_enabled | default(enable_basic_firewall | default(true))) | bool and not (manage_raw_ufw_user_rules | default(false))
  tags: [ 'firewall' ]

- name: Set UFW default policies
  ufw:
    direction: incoming
    policy: deny
  when: (firewall_enabled | default(enable_basic_firewall | default(true))) | bool and not (manage_raw_ufw_user_rules | default(false))
  tags: [ 'firewall' ]

- name: Allow outbound traffic (UFW default is allow)
  ufw:
    direction: outgoing
    policy: allow
  when: (firewall_enabled | default(enable_basic_firewall | default(true))) | bool and not (manage_raw_ufw_user_rules | default(false))
  tags: [ 'firewall' ]

- name: Allow required TCP service ports
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: "{{ firewall_allowed_tcp_ports | default([22,80,443]) }}"
  when: (firewall_enabled | default(enable_basic_firewall | default(true))) | bool and not (manage_raw_ufw_user_rules | default(false))
  tags: [ 'firewall' ]

- name: Enable UFW (safe enable after rules)
  ufw:
    state: enabled
  when: (firewall_enabled | default(enable_basic_firewall | default(true))) | bool
  tags: [ 'firewall' ]

- name: Configure fail2ban
  template:
    src: fail2ban.j2
    dest: /etc/fail2ban/jail.local
  notify: restart fail2ban

- name: Create deploy user
  user:
    name: "{{ ansible_user }}"
    shell: /bin/bash
    state: present
    groups: sudo
    append: yes

- name: Configure sudoers for deploy user
  copy:
    content: "{{ ansible_user }} ALL=(ALL) NOPASSWD:ALL"
    dest: /etc/sudoers.d/{{ ansible_user }}
    mode: '0440'

- name: Configure SSH keys for deploy user
  authorized_key:
    user: "{{ ansible_user }}"
    state: present
    key: "{{ lookup('file', ansible_ssh_private_key_file) }}"
  when: ansible_ssh_private_key_file is defined

- name: Ensure home directory permissions
  file:
    path: /home/{{ ansible_user }}
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0700'
    recurse: yes

- name: Copy SSH config
  copy:
    src: ssh_config.j2
    dest: /home/{{ ansible_user }}/.ssh/config
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'

- name: Create log directory
  file:
    path: /var/log/ansible
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create backup directory
  file:
    path: /var/backups/ansible
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create cache directory
  file:
    path: /var/cache/ansible
    state: directory
    owner: root
    group: root
    mode: '0755'

# Docker repository setup (conflict-free)
## Removed Docker repo setup (delegated to dedicated docker role) to avoid duplication & conflicts
