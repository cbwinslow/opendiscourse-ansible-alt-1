# LocalAI Prometheus metrics configuration
# Managed by Ansible - Do not edit manually

scrape_configs:
  - job_name: 'localai'
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: '{{ local_ai_metrics_path | default("/metrics") }}'
    scheme: {{ 'https' if local_ai_ssl_enabled else 'http' }}
    
    # For service discovery in Docker Swarm/Compose
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 30s
        filters:
          - name: label
            values: ['com.docker.compose.service=localai']
    
    # Static targets if not using Docker SD
    static_configs:
      - targets: ['localhost:{{ local_ai_integrations.prometheus.port | default(2112) }}']
        labels:
          instance: '{{ inventory_hostname }}'
          service: 'localai'
          environment: '{{ env | default("production") }}'
    
    # Relabeling rules for better metrics
    relabel_configs:
      # Add instance label from container name
      - source_labels: [__meta_docker_container_name]
        regex: '/(.*)'
        target_label: 'instance'
        replacement: '$1'
      
      # Add service label
      - source_labels: [__meta_docker_container_label_com_docker_compose_service]
        target_label: 'service'
      
      # Add environment label
      - source_labels: [__meta_docker_container_label_com_docker_compose_project]
        target_label: 'environment'
      
      # Add container ID
      - source_labels: [__meta_docker_container_id]
        target_label: 'container_id'
      
      # Add hostname
      - source_labels: [__meta_docker_container_label_com_docker_compose_config_hashes]
        target_label: 'config_hash'
    
    # Metrics relabeling to reduce cardinality
    metric_relabel_configs:
      # Drop high-cardinality metrics
      - source_labels: [__name__]
        regex: '(go_gc_duration_seconds|go_goroutines|go_threads|process_cpu_seconds_total|process_open_fds|process_resident_memory_bytes|process_start_time_seconds)'
        action: drop
      
      # Add environment label to all metrics
      - target_label: 'environment'
        replacement: '{{ env | default("production") }}'
      
      # Add host label
      - target_label: 'host'
        replacement: '{{ inventory_hostname }}'

# Alerting rules for LocalAI
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

rule_files:
  - 'localai-alerts.yml'

# Remote write configuration if using a centralized Prometheus
remote_write:
  - url: 'http://prometheus:9090/api/v1/write'
    queue_config:
      max_samples_per_send: 10000
      max_shards: 200
      capacity: 10000
    write_relabel_configs:
      - source_labels: [__name__]
        regex: 'up|process_.*|promhttp_metric_handler_requests_.*'
        action: keep
